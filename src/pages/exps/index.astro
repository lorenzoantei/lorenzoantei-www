---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';

import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

// Recupera tutti i post ordinati per data
const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Ottieni anni unici
const years = [...new Set(posts.map((p) => new Date(p.data.pubDate).getFullYear()))].sort((a, b) => b - a);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <main>
      <section class="p-6">
        <!-- Pulsanti Anni -->
        <div class="mb-6 flex gap-2 flex-wrap">
          <!-- <button data-year="all" class="filter-btn px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">All</button> -->
          {years.map((year) => (
            <button data-year={year} class="filter-btn px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">{year}</button>
          ))}
		<a href="/" class="filter-btn px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">goto Homepage</a>
        </div>

        <!-- Lista Esperienze -->
        <ul id="posts-list" class="grid gap-6">
          {posts.map((post) => {
            const year = new Date(post.data.pubDate).getFullYear();
            return (
              <li data-year={year} class="post-item">
                <a href={`/exps/${post.id}/`}>
                  {post.data.heroImage && (
                    <Image width={720} height={360} src={post.data.heroImage} alt="" />
                  )}
                  <h4 class="title">{post.data.title}</h4>
                  <p class="date">
                    <FormattedDate date={post.data.pubDate} />
                  </p>
                </a>
              </li>
            );
          })}
        </ul>
      </section>
    </main>
    <Footer />

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const buttons = document.querySelectorAll(".filter-btn");
        const posts = document.querySelectorAll(".post-item");

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const year = btn.getAttribute("data-year");

            posts.forEach((post) => {
              if (year === "all" || post.getAttribute("data-year") === year) {
                post.style.display = "";
              } else {
                post.style.display = "none";
              }
            });
          });
        });
      });
    </script>
  </body>
</html>
