---
import { SITE_TITLE } from "../consts";

import FormattedDate from '../components/FormattedDate.astro';

const { 
  activePage = '',
  expTitle = '',
  expDate = ''
 } = Astro.props;

import { getCollection } from 'astro:content';
import { getTranslations, getLocale } from '../utils/i18n.js';

// mappa locale -> collezione
const collectionsMap = {
  en: 'expsEnList',
  it: 'expsItList',
};


const locale = getLocale(Astro.url.pathname);
// fallback nel caso in cui locale non sia trovato
const collectionName = collectionsMap[locale] ?? 'expsEnList';

// Recupera tutti i exp ordinati per data
const exps = (await getCollection(collectionName))
  .filter((exp) => exp.data.published === true)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Ottieni anni unici
const years = [...new Set(exps.map((p) => new Date(p.data.pubDate).getFullYear()))]
  .sort((a, b) => b - a);

const t = getTranslations(Astro.url.pathname);

import LangSwitch from '../components/LangSwitch.astro';

// calcola la lingua opposta
const fixedLocale = locale === "it" ? "it" : "";

---
<div id="navbar-container" class="invert bg-white w-screen fixed top-0 z-[99] shadow-lg shadow-white md:px-6 lg:px-32 transition-all duration-800 ease-in-out">
  <navbar class="w-full">
    <!-- TITLE -->
    <div class="flex justify-between">
      <div class="p-4 flex items-start font-pixelify">
        <a
          id="site-title"
          class="z-[999] text-black text-3xl transition-colors duration-3000 ease-in-out hover:animate-pulse hover:text-pink-500 pr-4 pl-2 py-2"
          href={fixedLocale ? `/${fixedLocale}/` : `/`}
        >
          {SITE_TITLE}
        </a>

      </div>

      <div id="lang-switch" class="mt-10 md:mt-9 transition-opacity duration-500">
        <LangSwitch />
      </div>

  </div>

    <!-- MENU (inizialmente nascosto) -->
    <div
      id="menu"
      class="overflow-hidden max-h-0 opacity-0 flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0 px-6 transition-all duration-800 ease-in-out"
    >
      <div
        class={activePage == 'exps'
          ? 'hidden'
          : 'opacity-0 translate-y-2 transition-all duration-500 ease-in-out delay-150 text-xl'
        }
      >
      <div class="-pl-1 md:pl-0 pb-3">
        <h2 class="text-md md:text-xl">{expTitle}</h2>
        <div class="text-xs"><FormattedDate date={expDate} /></div>
      </div>
    </div>
      
    </div>


  </navbar>

</div>

<!-- Script scroll -->
<script>
  const menu = document.getElementById("menu");
  const navbarcontainer = document.getElementById("navbar-container");
  const menuLinks = menu.querySelectorAll("div");
  const title = document.getElementById("site-title");

  let lastScrollY = window.scrollY;
  let hideTimeout;

  function showMenu() {
    menu.classList.remove("max-h-0", "opacity-0");
    menu.classList.add("max-h-40", "opacity-100");

    menuLinks.forEach((link, i) => {
      setTimeout(() => {
        link.classList.remove("opacity-0", "translate-y-2");
        link.classList.add("opacity-100", "translate-y-0");
      }, i * 150);
    });
  }

  function hideMenu() {
    menu.classList.remove("max-h-40", "opacity-100");
    menu.classList.add("max-h-0", "opacity-0");

    menuLinks.forEach((link) => {
      link.classList.add("opacity-0", "translate-y-2");
      link.classList.remove("opacity-100", "translate-y-0");
    });
  }

const langSwitch = document.getElementById("lang-switch");

function handleScroll() {
  clearTimeout(hideTimeout);

  if (window.scrollY === 0) {
    showMenu();
    if (langSwitch) {
      langSwitch.style.opacity = "1";
      langSwitch.style.pointerEvents = "auto";
    }
    if (navbarcontainer) {
      navbarcontainer.classList.remove("invert");
    }
    return;
  } else {
    if (navbarcontainer) {
      navbarcontainer.classList.add("invert");
    }

    if (langSwitch) {
      langSwitch.style.opacity = "0";
      langSwitch.style.pointerEvents = "none";
    }
  }

    if (window.scrollY > lastScrollY) {
      // Scroll verso il basso
      hideMenu();
    } else {
      // Scroll verso lâ€™alto
      showMenu();

      // Nascondo di nuovo dopo 3s
      hideTimeout = setTimeout(() => {
        hideMenu();
      }, 3000);
    }

    // // Effetto quadrato nero sul title
    // if (window.scrollY > 50) {
    //   title.classList.add("bg-black", "text-white", "shadow-md");
    // } else {
    //   title.classList.remove("bg-black", "text-white", "shadow-md");
    // }

    lastScrollY = window.scrollY;
  }

  window.addEventListener("scroll", handleScroll);

  // Mostra menu subito se sei in cima quando carica la pagina
  if (window.scrollY === 0) {
    showMenu();
  }
</script>
